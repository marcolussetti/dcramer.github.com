---
layout: post
title: Creating a Read-only Mirror for your GitHub Server
categories: ["disqus", "git"]
---

<p>Recently we've been transitioning our git repositories to GitHub. We chose to go this route for a variety of reasons, but mostly
because they have kickass pull requests, which we're going to test run as code reviews. However, one of the requirements of this process was that
our original git-server still remain functional, in at least a read-only state. This saves us the time of having to update deploy and
other scripts which read from this mirror and perform various tasks.</p>

<p>I was a bit surprised when I originally searched around for this, as I was either failing horribly at Google (granted, my queries were "how to setup git-server mirror"), or there just wasn't much information out there on it. After a bit of crawling I found what seems to be a pretty easy way to get the behavior we wanted. For a recap, here's a checklist of what we needed:</p>

<ul>
    <li>Read-only git server</li>
    <li>One-way mirror from our new server to the legacy server.</li>
    <li>Mirror all branches</li>
    <li>Updated near real-time</li>
</ul>

<p>So, given this, we created a simple bash script that runs on a 1 minute cron timer (it's as close to real-time as we needed):</p>

{% highlight bash %}
#!/bin/bash

mkdir -p  /var/git/mirrors/

cd /var/git/mirrors/

# clone our newly acquired GitHub mirror
git clone --mirror git@github.com:organization/repo-name.git

cd disqus.git

# Add our local remote
git remote add local /var/git/repositories/repo-name.git

# Unsure if we need to fetch from local, but let's do it anyways
git fetch origin
git fetch local

# push all changes to local using --mirror (ensures all refs in remotes are pushed)
git push local --mirror
{% endhighlight %}

<p>Since we were already using gitosis for permissions, it was easy for us to deprecate the legacy repo by simply moving everyone into a readable group that lacks write privileges.</p>

<p>Would love to hear some feedback from avid git users if there's a better way to do this.</p>
