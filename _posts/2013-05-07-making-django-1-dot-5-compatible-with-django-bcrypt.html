---
layout: post
title: "Making Django 1.5 compatible with django-bcrypt"
date: 2013-05-07 08:43
comments: true
categories: ["django"]
---

<p>Last night I took the opportunity to upgrade all of <a href="https://getsentry.com">getsentry.com</a> to
Django 1.5. While most things were fairly trivial to sort out, we hit one less obvious (and pretty critical) bug
during the migration surrounding <a href="https://github.com/dwaiter/django-bcrypt">django-bcrypt</a>.</p>

<p>This bug would only present itself if you've transitioned from older versions of Django, and therefore have passwords
in the database using the custom algorithm. Specifically, you'll have passwords in your user's table that look something
like <code>bc$$somestring$12$somestring</code>.</p>

<p>The fix is actually fairly simple, and just requires you to define a slightly custom legacy backend for django-bcrypt:</p>

{% highlight python %}
from django.contrib.auth.hashers import BCryptPasswordHasher


class DjangoBCryptPasswordHasher(BCryptPasswordHasher):
    """
    Handles legacy passwords which were hashed with the 'bc$' algorithm via
    django-bcrypt.
    """
    algorithm = "bc"
{% endhighlight %}

<p>Once you've defined the backend, the rest is as simple as adding it to your list of password hashers:</p>

{% highlight python %}
PASSWORD_HASHERS = (
    'django.contrib.auth.hashers.PBKDF2PasswordHasher',
    'django.contrib.auth.hashers.PBKDF2SHA1PasswordHasher',
    'django.contrib.auth.hashers.BCryptPasswordHasher',
    'getsentry.utils.auth.DjangoBCryptPasswordHasher',
    'django.contrib.auth.hashers.SHA1PasswordHasher',
    'django.contrib.auth.hashers.MD5PasswordHasher',
)
{% endhighlight %}

<p><strong>Update:</strong> As pointed out by <a href="https://twitter.com/chrisstreeter/status/331808483982843904">@chrisstreeter</a> it's also fairly trivial to do a data migration: <a href="https://gist.github.com/streeter/5534008">https://gist.github.com/streeter/5534008</a></p>
