---
layout: post
title: Error Tracing in Sentry
categories: ["django", "disqus", "sentry"]
---

<p>A few weeks ago we pushed out an update to <a href="http://github.com/dcramer/django-sentry">Sentry</a>, bumping it's version to 1.6.0. Among the changes was a new "Sentry ID" value which is created by the client, rather than relying on the server. This seems like something insignificant, but it allows you to do something very powerful: trace errors from the customer or developer down to the precise request and log entry.</p>

<h4>Exposing Sentry ID</h4>

<p>The new IDs are generated automatically when a message is processed (by the client), so you won't need to make any changes on that end. Likely, however, you're going to want to expose these at your application level for a couple of different reasons. The first one we're going to cover is your customer's experience.</p>

<p>The easiest way to expose this information in a useful manner, is by <strong>creating a modified 500.html</strong>. In DISQUS' case, we mention the error reference ID to the end-user, so that when they're reporting a problem they can pass along this information.</p>

<h5>Create a custom 500 handler</h5>

<p>The first thing you're going to need to do is to create a custom 500 handler. This defined in <code>urls.py</code>, so we're just going to go ahead and create the view in-place.</p>

{% highlight python %}
def handler500(request):
    """
    An error handler which exposes the request object to the error template.
    """
    from django.template import Context, loader
    from django.http import HttpResponseServerError
    from disqus.context_processors import default
    import logging
    import sys
    try:
        context = default(request)
    except Exception, e:
        logging.error(e, exc_info=sys.exc_info(), extra={'request': request})
        context = {}

    context['request'] = request

    t = loader.get_template('500.html') # You need to create a 500.html template.
    return HttpResponseServerError(t.render(Context(context)))
{% endhighlight %}

<p>We're going to expose the request object to our 500.html in the above. Keep in mind, that doing this allows you to add some logic into your template, and you're going to need to be very careful that this logic can't raise a new exception.</p>

<h5>Tweaking your 500.html</h5>

<p>The next thing you'll need to do is to tweak your 500.html template to actually show the Sentry ID. Assuming the request object was passed into Sentry, it will attach the last error seen under <code>request.sentry['id']</code>. Given this, we can easily report it to the end-user in our template:</p>

<pre>
&lt;p&gt;The Disqus team has been alerted and we're on the case. For more information, check out &lt;a href="http://status.disqus.com"&gt;Disqus Status &raquo;&lt;/a&gt;&lt;/p&gt;
&#123;% if request.sentry.id %&#125;
    &lt;p&gt;If you need assistance, you may reference this error as &lt;strong&gt;&#123;&#123; request.sentry.id &#125;&#125;&lt;/strong&gt;.&lt;/p&gt;
&#123;% endif %&#125;
</pre>

<h4>Sentry ID as a response header</h4>

<p>The other quick solution to get access to this variable is simply by enabling an included response middleware, <code>SentryResponseErrorIdMiddleware</code>. Just pop open your <code>settings.py</code> and append it to your <code>MIDDLEWARE_CLASSES</code>:</p>

{% highlight python %}
MIDDLEWARE_CLASSES = (
    ...,
    'sentry.client.middleware.SentryResponseErrorIdMiddleware',
)
{% endhighlight %}

<p>Now if you check your response headers after hitting an error, you should see <code>X-Sentry-ID</code>.</p>

<h4>Find errors by ID</h4>

<p>Sentry makes it very easy to pull up error messages by ID. The one requirement is that you're going to need to ensure <code>sentry.filters.SearchFilter</code> is included within <code>SENTRY_FILTERS</code> (it's enabled by default). Once done, Sentry will discover if you're entering a UUID hex value (the Sentry ID) in the search box, and it will jump directly to that error's page.</p>

<p><img src="http://f.cl.ly/items/2f1s1X0J231F2F3u0V0d/sentry-id.png"/></p>

<p>You'll also notice that all messages are now tagged with their unique Sentry ID as well (per the screenshot).</p>
