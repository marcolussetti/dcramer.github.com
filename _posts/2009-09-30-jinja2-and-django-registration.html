---
wordpress_id: 486
layout: post
title: Jinja2 and django-registration
wordpress_url: http://www.davidcramer.net/?p=486
categories: ["django"]
---
<p>One of the many issues which one must overcome with Jinja2 is using it with 3rd party modules. A lot of these already have built-in views, and many have yet to realize the benefit of class-based views. Today, I'm going to explain how we approached this for <a href="http://www.djangospot.com">DjangoSpot</a> (<a href="http://www.github.com/dcramer/djangospot">GitHub</a>) and <a href="http://bitbucket.org/ubernostrum/django-registration">django-registration</a>.</p>

<p>The goal, as always, is the write the least amount of code. However, extending function-based views is now an easy task. So our approach involves using some tricky Python code (thanks to Chris Leary for the ideas!).</p>

<p>Let's talk about requirements real quick. You'll need Django 1.1 (or newer), <a href="http://jinja.pocoo.org/2">Jinja2</a>, and <a href="http://www.github.com/dcramer/coffin">Coffin</a> 0.3.1 or newer (which as of writing, is not on PyPi).</p>

<p>First off, we're going to use <code>inspect.getsource</code> to retrieve source code for functions, and <code>exec</code> to evaluate that source code. One thing to note here, is that if the function you are trying to modify is using a decorator, it may not be possible to get the actual functions source code. Some, however, can be obtained by using <code>my_function.func_var_name</code>.</p>

<p>So let's take a look at our <code>urls.py</code> in <code>djangospot.accounts.urls</code>:</p>

{% highlight python %}
import inspect

from registration import urls

exec inspect.getsource(urls)\
     .replace('django.contrib.auth', 'coffin.contrib.auth')
{% endhighlight %}

As you can see above, we're importing the <code>urls</code> from django registration, and then running <code>getsource</code> on it. This gets us the source code from that entire file. From there, we simply swap out <code>django.contrib.auth</code> for our drop-in <code>coffin.contrib.auth</code>.

Next up, we need to handle the views. It's a similar approach, except we're not doing any tricky string replacement:

{% highlight python %}

import inspect

from registration.views import *

from coffin.shortcuts import render_to_response
from coffin.template import RequestContext

exec inspect.getsource(activate)
exec inspect.getsource(register)
{% endhighlight %}

<p>What we're doing here, is getting the source code for the actual methods, and simply executing it. To ensure we have all the needed imports, we first import everything from the <code>registration.views</code>. Afterwards, we replace the <code>render_to_response</code> and <code>RequestContext</code> imports with the ones made available in Coffin.</p>

<p>Overall, it's a fairly sketchy process, but it works beautiful. We approach the problem in a similar fashion with Coffin and the generic and contrib views in there.</p>
